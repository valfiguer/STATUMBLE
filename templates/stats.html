<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Bumble Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-page {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1D2129;
        }
        
        .page-subtitle {
            font-size: 14px;
            color: #65676B;
            margin-top: 5px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #1D2129;
        }
        
        .stat-label {
            font-size: 13px;
            color: #65676B;
            margin-top: 8px;
        }
        
        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .stat-change.positive {
            background: #D4EDDA;
            color: #155724;
        }
        
        .stat-change.negative {
            background: #F8D7DA;
            color: #721C24;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #1D2129;
            margin-bottom: 20px;
        }
        
        .activity-section {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        .activity-title {
            font-size: 18px;
            font-weight: 600;
            color: #1D2129;
            margin-bottom: 20px;
        }
        
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #F0F0F0;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 15px;
        }
        
        .activity-icon.like { background: #FFF3CD; }
        .activity-icon.match { background: #D4EDDA; }
        .activity-icon.view { background: #E3F2FD; }
        .activity-icon.autolike { background: #FCE4EC; }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 14px;
            color: #1D2129;
        }
        
        .activity-time {
            font-size: 12px;
            color: #65676B;
            margin-top: 2px;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .insight-card {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
        }
        
        .insight-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .insight-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .insight-detail {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">üêù Bumble</a>
        <div class="navbar-menu">
            <a href="/" class="navbar-link">Monitor</a>
            <a href="/matches" class="navbar-link">Matches</a>
            <a href="/historial" class="navbar-link">Historial</a>
            <a href="/stats" class="navbar-link active">Estad√≠sticas</a>
        </div>
        <div class="navbar-status" id="monitorStatus">
            <span class="status-dot offline"></span>
            <span class="status-text">Monitor: Detenido</span>
        </div>
    </nav>

    <div class="stats-page">
        <div class="page-header">
            <div class="page-title">üìä Estad√≠sticas</div>
            <div class="page-subtitle">An√°lisis de tu actividad en Bumble</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üíõ</div>
                <div class="stat-value" id="totalLikes">0</div>
                <div class="stat-label">Te dieron Like</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíï</div>
                <div class="stat-value" id="totalMatches">0</div>
                <div class="stat-label">Total Matches</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úì</div>
                <div class="stat-value" id="verifiedCount">0</div>
                <div class="stat-label">Perfiles Verificados</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì∑</div>
                <div class="stat-value" id="instagramCount">0</div>
                <div class="stat-label">Con Instagram</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí°</div>
                <div class="stat-value" id="interestsCount">0</div>
                <div class="stat-label">Con Intereses</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ü§ñ</div>
                <div class="stat-value" id="autolikesCount">0</div>
                <div class="stat-label">AutoLikes Enviados</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">üìà Distribuci√≥n por Edad</div>
                <div class="chart-subtitle">Edades de personas que te dieron like</div>
                <canvas id="ageChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">üîÑ Likes Recibidos vs Matches</div>
                <div class="chart-subtitle">Tasa de conversi√≥n a match</div>
                <canvas id="matchRatioChart"></canvas>
            </div>
        </div>

        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-title">üíé Tasa de Match</div>
                <div class="insight-value" id="matchRate">0%</div>
                <div class="insight-detail">De los likes recibidos que se convirtieron en match</div>
            </div>
            <div class="insight-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="insight-title">üéØ Edad Promedio</div>
                <div class="insight-value" id="avgAge">-</div>
                <div class="insight-detail">Edad promedio de las personas que te dan like</div>
            </div>
            <div class="insight-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="insight-title">üìç Ciudad m√°s com√∫n</div>
                <div class="insight-value" id="topCity">-</div>
                <div class="insight-detail">De donde vienen la mayor√≠a de tus likes</div>
            </div>
        </div>

        <div class="activity-section" style="margin-top: 30px;">
            <div class="activity-title">üìã Actividad Reciente</div>
            <div class="activity-list" id="activityList">
                <!-- Activity items -->
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let ageChart, matchRatioChart;

        socket.on('connect', () => {
            socket.emit('get_full_stats');
        });

        // Escuchar nuevos usuarios en tiempo real para actualizar stats
        socket.on('new_user', (user) => {
            // Re-fetch stats when new user arrives
            socket.emit('get_full_stats');
        });

        // Escuchar estado del monitor
        socket.on('status_update', (data) => {
            updateMonitorStatus(data.status);
        });

        socket.on('initial_state', (data) => {
            updateMonitorStatus(data.is_running ? 'running' : 'stopped');
        });

        // Escuchar autolikes
        socket.on('autolike_status', (data) => {
            document.getElementById('autolikesCount').textContent = data.count || 0;
        });

        function updateMonitorStatus(status) {
            const statusDiv = document.getElementById('monitorStatus');
            if (statusDiv) {
                const isRunning = status === 'running' || status === 'monitoring';
                statusDiv.innerHTML = `
                    <span class="status-dot ${isRunning ? 'online' : 'offline'}"></span>
                    <span class="status-text">Monitor: ${isRunning ? 'Activo' : 'Detenido'}</span>
                `;
            }
        }

        socket.on('full_stats', (data) => {
            // Update main stats
            document.getElementById('totalLikes').textContent = data.stats.total || 0;
            document.getElementById('totalMatches').textContent = data.stats.matches || 0;
            document.getElementById('verifiedCount').textContent = data.stats.verified || 0;
            document.getElementById('instagramCount').textContent = data.stats.with_instagram || 0;
            document.getElementById('interestsCount').textContent = data.stats.with_interests || 0;
            document.getElementById('autolikesCount').textContent = data.autolike_count || 0;

            // Calculate match rate
            const matchRate = data.stats.total > 0 
                ? ((data.stats.matches / data.stats.total) * 100).toFixed(1)
                : 0;
            document.getElementById('matchRate').textContent = matchRate + '%';

            // Calculate average age
            if (data.age_distribution) {
                let totalAge = 0, count = 0;
                for (const [age, num] of Object.entries(data.age_distribution)) {
                    totalAge += parseInt(age) * num;
                    count += num;
                }
                const avgAge = count > 0 ? (totalAge / count).toFixed(1) : '-';
                document.getElementById('avgAge').textContent = avgAge + ' a√±os';
            }

            // Top city
            if (data.city_distribution) {
                const topCity = Object.entries(data.city_distribution)
                    .filter(([city]) => city && city !== '')
                    .sort((a, b) => b[1] - a[1])[0];
                document.getElementById('topCity').textContent = topCity ? topCity[0] : 'Sin datos';
            }

            // Update charts
            updateAgeChart(data.age_distribution);
            updateMatchRatioChart(data.stats);

            // Update activity list
            updateActivityList(data.recent_activity);
        });

        function updateAgeChart(distribution) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            
            if (ageChart) ageChart.destroy();
            
            const labels = Object.keys(distribution || {}).sort((a, b) => a - b);
            const values = labels.map(age => distribution[age]);

            ageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: values,
                        backgroundColor: 'rgba(255, 215, 0, 0.8)',
                        borderColor: 'rgba(255, 165, 0, 1)',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function updateMatchRatioChart(stats) {
            const ctx = document.getElementById('matchRatioChart').getContext('2d');
            
            if (matchRatioChart) matchRatioChart.destroy();

            matchRatioChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Matches', 'Likes sin match'],
                    datasets: [{
                        data: [stats.matches || 0, (stats.new_likes || 0)],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateActivityList(activities) {
            const list = document.getElementById('activityList');
            list.innerHTML = '';

            if (!activities || activities.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #65676B;">No hay actividad reciente</div>';
                return;
            }

            activities.forEach(activity => {
                const iconClass = getActivityIcon(activity.action_type);
                const time = new Date(activity.timestamp).toLocaleString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-icon ${iconClass.class}">${iconClass.emoji}</div>
                    <div class="activity-content">
                        <div class="activity-text">${formatActivityText(activity)}</div>
                        <div class="activity-time">${time}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function getActivityIcon(type) {
            const icons = {
                'like_received': { emoji: 'üíõ', class: 'like' },
                'match': { emoji: 'üíï', class: 'match' },
                'autolike': { emoji: 'ü§ñ', class: 'autolike' },
                'profile_view': { emoji: 'üëÅÔ∏è', class: 'view' },
                'default': { emoji: 'üìå', class: '' }
            };
            return icons[type] || icons.default;
        }

        function formatActivityText(activity) {
            switch (activity.action_type) {
                case 'like_received':
                    return `Nuevo like de ${activity.user_name || 'alguien'}`;
                case 'match':
                    return `¬°Match con ${activity.user_name}!`;
                case 'autolike':
                    return `AutoLike enviado`;
                case 'profile_view':
                    return `Perfil visto: ${activity.user_name}`;
                default:
                    return activity.details || 'Actividad';
            }
        }
    </script>
</body>
</html>
